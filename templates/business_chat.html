{% extends "base.html" %}

{% block title %}Business Chat - Digi Farm Management{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-md-4 col-lg-3">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>Chat Rooms
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for room in chat_rooms %}
                        <a href="#" class="list-group-item list-group-item-action" 
                           data-room-id="{{ room.id }}" data-room-name="{{ room.name|tojson }}"
                           onclick="openChatRoomFromElement(this)">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ room.name }}</h6>
                                    <p class="mb-1 text-muted small">{{ room.last_message }}</p>
                                    <small class="text-muted">{{ room.last_time }}</small>
                                </div>
                                <div class="text-end">
                                    {% if room.active %}
                                    <span class="badge bg-success rounded-pill">{{ room.members }}</span>
                                    {% else %}
                                    <span class="badge bg-secondary rounded-pill">{{ room.members }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-plus me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-sm btn-outline-success w-100 mb-2">
                        <i class="fas fa-store me-1"></i>Find Suppliers
                    </button>
                    <button class="btn btn-sm btn-outline-primary w-100 mb-2">
                        <i class="fas fa-shopping-cart me-1"></i>Find Buyers
                    </button>
                    <button class="btn btn-sm btn-outline-warning w-100">
                        <i class="fas fa-handshake me-1"></i>Create Deal
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-8 col-lg-9">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" id="chatRoomTitle">
                            <i class="fas fa-comment-dots me-2"></i>Select a chat room to start
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-secondary" title="Search Messages">
                                <i class="fas fa-search"></i>
                            </button>
                            <button class="btn btn-outline-secondary" title="Room Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body d-flex flex-column" style="height: 500px;">
                    <div class="flex-grow-1 overflow-auto" id="chatMessages">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-comments fa-3x mb-3"></i>
                            <h5>Welcome to Business Chat</h5>
                            <p>Connect with suppliers and buyers for chickens, pigs, and farm equipment.</p>
                            <p>Select a chat room from the left to start chatting.</p>
                        </div>
                    </div>
                    <div class="mt-3" id="chatInput" style="display: none;">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Type your message..." 
                                   id="messageInput" onkeypress="handleEnter(event)">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentChatRoom = null;

function openChatRoomFromElement(element) {
    const roomId = parseInt(element.dataset.roomId);
    const roomName = JSON.parse(element.dataset.roomName);
    openChatRoom(roomId, roomName);
}

function openChatRoom(roomId, roomName) {
    currentChatRoom = roomId;
    const safeRoomName = roomName.replace(/[<>&"']/g, function(char) {
        const entityMap = {'<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'};
        return entityMap[char];
    });
    document.getElementById('chatRoomTitle').innerHTML = `<i class="fas fa-comment-dots me-2"></i>${safeRoomName}`;
    document.getElementById('chatInput').style.display = 'block';
    
    // Mock chat messages
    const messages = [
        { sender: 'Rajesh Kumar', message: 'Looking for 500 broiler chicks this week. Quality must be good.', time: '10:30 AM', isOwn: false },
        { sender: 'You', message: 'I have premium broiler chicks available. What price range are you looking for?', time: '10:32 AM', isOwn: true },
        { sender: 'Priya Sharma', message: 'I can also supply. My farm has excellent biosecurity record.', time: '10:35 AM', isOwn: false },
        { sender: 'Rajesh Kumar', message: 'Great! Can we discuss pricing and delivery terms?', time: '10:37 AM', isOwn: false }
    ];
    
    let chatHTML = '';
    messages.forEach(msg => {
        const alignClass = msg.isOwn ? 'text-end' : 'text-start';
        const bgClass = msg.isOwn ? 'bg-primary text-white' : 'bg-light';
        chatHTML += `
            <div class="mb-3 ${alignClass}">
                <div class="d-inline-block ${bgClass} rounded p-2 mw-75">
                    <div class="fw-bold small">${msg.sender}</div>
                    <div>${msg.message}</div>
                    <small class="opacity-75">${msg.time}</small>
                </div>
            </div>
        `;
    });
    
    document.getElementById('chatMessages').innerHTML = chatHTML;
    document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
}

function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (message && currentChatRoom) {
        const chatMessages = document.getElementById('chatMessages');
        const messageHTML = `
            <div class="mb-3 text-end">
                <div class="d-inline-block bg-primary text-white rounded p-2 mw-75">
                    <div class="fw-bold small">You</div>
                    <div>${message}</div>
                    <small class="opacity-75">Just now</small>
                </div>
            </div>
        `;
        chatMessages.innerHTML += messageHTML;
        chatMessages.scrollTop = chatMessages.scrollHeight;
        input.value = '';
    }
}

function handleEnter(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}
</script>

<style>
.mw-75 {
    max-width: 75%;
}
</style>
{% endblock %}